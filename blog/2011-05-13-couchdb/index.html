<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>CouchDB | David Pilato</title>
<meta name=generator content="Hugo Eureka 0.8.4">
<link rel=stylesheet href=https://david.pilato.fr/css/eureka.min.css>
<script defer src=https://david.pilato.fr/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<meta name=description content="Après avoir testé Elasticsearch, me voici parti pour regarder ce monde étrange qu&rsquo;on appelle le NoSQL&mldr;
A dire vrai, j&rsquo;ai entendu ce mot il y a quelques années, sans jamais vraiment m&rsquo;y interesser&mldr; Après tout, une base de données non SQL, ça n&rsquo;est tout simplement pas possible !!!
Puis, à force de cotoyer le monde d&rsquo;Elasticsearch et les technos JSon et REST, je me lance.
Pour des raisons très pratiques, je choisis CouchDB de Apache. D&rsquo;une part, il est directement intégrable avec Elasticsearch, et à la lecture rapide de sa documentation, il semble répondre à un des besoins auquel une équipe de mon pôle de développement est confrontée.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://david.pilato.fr/blog/"},{"@type":"ListItem","position":2,"name":"CouchDB","item":"https://david.pilato.fr/blog/2011-05-13-couchdb/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://david.pilato.fr/blog/2011-05-13-couchdb/"},"headline":"CouchDB | David Pilato","datePublished":"2011-05-13T21:08:22+00:00","dateModified":"2011-05-13T21:08:22+00:00","wordCount":887,"author":{"@type":"Person","name":["David Pilato"]},"publisher":{"@type":"Person","name":"David Pilato"},"description":"Après avoir testé Elasticsearch, me voici parti pour regarder ce monde étrange qu\u0026rsquo;on appelle le NoSQL\u0026hellip;\nA dire vrai, j\u0026rsquo;ai entendu ce mot il y a quelques années, sans jamais vraiment m\u0026rsquo;y interesser\u0026hellip; Après tout, une base de données non SQL, ça n\u0026rsquo;est tout simplement pas possible !!!\nPuis, à force de cotoyer le monde d\u0026rsquo;Elasticsearch et les technos JSon et REST, je me lance.\nPour des raisons très pratiques, je choisis CouchDB de Apache. D\u0026rsquo;une part, il est directement intégrable avec Elasticsearch, et à la lecture rapide de sa documentation, il semble répondre à un des besoins auquel une équipe de mon pôle de développement est confrontée."}</script><meta property="og:title" content="CouchDB | David Pilato">
<meta property="og:type" content="article">
<meta property="og:url" content="https://david.pilato.fr/blog/2011-05-13-couchdb/">
<meta property="og:description" content="Après avoir testé Elasticsearch, me voici parti pour regarder ce monde étrange qu&rsquo;on appelle le NoSQL&mldr;
A dire vrai, j&rsquo;ai entendu ce mot il y a quelques années, sans jamais vraiment m&rsquo;y interesser&mldr; Après tout, une base de données non SQL, ça n&rsquo;est tout simplement pas possible !!!
Puis, à force de cotoyer le monde d&rsquo;Elasticsearch et les technos JSon et REST, je me lance.
Pour des raisons très pratiques, je choisis CouchDB de Apache. D&rsquo;une part, il est directement intégrable avec Elasticsearch, et à la lecture rapide de sa documentation, il semble répondre à un des besoins auquel une équipe de mon pôle de développement est confrontée.">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="David Pilato">
<meta property="article:published_time" content="2011-05-13T21:08:22+00:00">
<meta property="article:modified_time" content="2011-05-13T21:08:22+00:00">
<meta property="article:section" content="blog">
<meta property="article:tag" content="couchdb">
<meta property="article:tag" content="elasticsearch">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2011-06-20-elasticsearch-et-les-facets/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2011-03-09-la-recherche-elastique/">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">David Pilato</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Home</a>
<a href=/blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Blog</a>
<a href=https://djdadoo.pilato.fr/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">DJ Mixes</a>
<a href=/authors/david-pilato/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About me</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">CouchDB</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2011-05-13</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>5 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=https://david.pilato.fr/categories/tutorial/ class=hover:text-eureka>tutorial</a>
</div>
<div class="mr-6 my-2">
<i class="fas fa-th-list mr-1"></i>
<a href=https://david.pilato.fr/series/d%C3%A9couverte-elasticsearch/ class=hover:text-eureka>Découverte Elasticsearch</a>
</div>
</div>
<div class=content>
<p>Après avoir testé <a href=https://david.pilato.fr/blog/2011-03-09-la-recherche-elastique/>Elasticsearch</a>, me voici parti pour regarder ce monde étrange qu&rsquo;on appelle le <a href=http://fr.wikipedia.org/wiki/Nosql>NoSQL</a>&mldr;</p>
<p>A dire vrai, j&rsquo;ai entendu ce mot il y a quelques années, sans jamais vraiment m&rsquo;y interesser&mldr; Après tout, une base de données non SQL, ça n&rsquo;est tout simplement pas possible !!!</p>
<p>Puis, à force de cotoyer le monde d&rsquo;Elasticsearch et les technos JSon et REST, je me lance.</p>
<p>Pour des raisons très pratiques, je choisis <a href=http://couchdb.apache.org/>CouchDB</a> de Apache. D&rsquo;une part, il est directement intégrable avec Elasticsearch, et à la lecture rapide de sa <a href=http://guide.couchdb.org/editions/1/fr/index.html>documentation</a>, il semble répondre à un des besoins auquel une équipe de mon pôle de développement est confrontée.</p>
<h2 id=notre-besoin-résumé>Notre besoin (résumé)</h2>
<ul>
<li>Archiver des données de notre SI afin notamment de décharger les bases live (Front Office).</li>
<li>Historiser ces données</li>
<li>Y associer des pièces jointes (vues PDF et XML)</li>
<li>Etre en mesure d&rsquo;y accéder facilement</li>
<li>Prévenir des consommateurs de ces documents qu&rsquo;il y a des nouveautés à récupérer et à traiter (Décisionnel)</li>
<li>Etre en mesure de rechercher ces document</li>
<li>&mldr;</li>
</ul>
<p>Au début, les équipes ont pensé mettre en place des copies via des fichiers XML dans des répertoires partagés depuis les applications Front Office (live), puis des scripts shell pour recopie dans des espaces propres à chaque consommateur de données qui traitera ensuite les flux à son rythme. Sans entrer dans les détails, c&rsquo;est un peu genre &ldquo;je fais tout moi-même à la main, comme je l&rsquo;aurais fait en 1995&rdquo;&mldr;</p>
<p>Depuis le monde a un peu changé, non ?</p>
<h2 id=alors-que-peut-faire-couchdb-pour-nous>Alors, que peut faire CouchDB pour nous?</h2>
<ul>
<li>Stocker des documents (format JSON)</li>
<li>Y associer des pièces jointes (PDF et XML)</li>
<li>Le tout avec un mode de transport simple : HTTP / REST</li>
<li>Gestion d&rsquo;un flux type RSS pour informer n&rsquo;importe qui de toutes les modifications apportées à la base</li>
<li>Gestion des révisions de chaque document</li>
<li>Non adhérence à un format particulier (contrairement aux SGBD-R)</li>
<li>Capacité de stockage et de montée en charge</li>
<li>Réplication ultra simple</li>
<li>Partitionnement</li>
<li>&mldr;</li>
</ul>
<p>Bon, ça c&rsquo;est sur le papier&mldr; Rien ne vaut un bon test&mldr;</p>
<p>On se lance donc avec un ami pour mettre en place une plate-forme de test.</p>
<p>Nous partons d&rsquo;une base de données disposant de plusieurs millions d&rsquo;enregistrements divers (sous Oracle). Notre objectif :</p>
<ul>
<li>Les lire avec un DAO classique dans Oracle</li>
<li>JSONiser chaque entité</li>
<li>La transformer aussi en une vue XML (module déjà existant)</li>
<li>La transformer aussi en une vue PDF (nous avons déjà développé tout cela avant)</li>
<li>Envoyer le tout à CouchDB.</li>
</ul>
<p>Il faut 5 minutes pour installer CouchDB (grand max !), 20 minutes pour comprendre que le firewall de Microsoft n&rsquo;est pas notre ami et que nous avons intérêt à ouvrir le port CouchDB si nous voulons pouvoir communiquer avec CouchDB depuis une autre machine !</p>
<p>On lance le batch sur une machine et on envoie vers un CouchDB&mldr; Là, tranquille, au rythme de 15-20 documents par seconde, notre base se remplit petit à petit !</p>
<p>On consulte un document JSON ainsi : <a href=http://couchdb/index/ref000000001/>http://couchdb/index/ref000000001/</a></p>
<p>Si on veut prendre la version PDF, c&rsquo;est beaucoup plus compliqué : <a href=http://couchdb/index/ref000000001/ref000000001.pdf>http://couchdb/index/ref000000001/ref000000001.pdf</a></p>
<p>Je passe la version XML&mldr; C&rsquo;est aussi compliqué !</p>
<p>Au bout de 50 000 documents, nous nous lançons un nouveau défi : répliquer sur une autre instance CouchDB.</p>
<p>Installation de CouchDB sur une autre machine. Cette fois, on ne perd pas de temps pour le firewall : on sait directement où enlever le blocage&mldr;</p>
<p>Puis on se connecte sur l<a href=http://127.0.0.1:5984/_utils/>&lsquo;interface de gestion de CouchDB</a> et on demande une réplication de la première machine vers la deuxième&mldr; Il faut 10 secondes pour configurer cela. C&rsquo;est vraiment trop simple pour fonctionner directement ! Mais, si ! Ca fonctionne !</p>
<p>La réplication commence&mldr; 20 à 50 documents répliqués par seconde&mldr; Le tout sur un PC assez lent. On est loin des conditions de PROD !</p>
<p>En même temps, notre BATCH continue à alimenter la première instance.</p>
<p>Arrivés à 100 000 documents, nous n&rsquo;en n&rsquo;avons pas assez !!!</p>
<p>Nous décidons de nous lancer un nouveau défi. Il nous reste 10 minutes avant une réunion de présentation de ces concepts à notre management. Nous avons largement le temps !</p>
<p>Alors, nous décidons de lancer un noeud Elasticsearch sur une machine et d&rsquo;y ajouter le <a href=https://github.com/elastic/elasticsearch-river-couchdb/>plugin river CouchDB</a>. Puis nous activons ce plugin pour ouvrir une rivière (river) vers la première instance de CouchDB&mldr; Et là, encore un miracle&mldr; Nos documents se déversent sans aucun effort dans Elasticsearch.</p>
<p>Nous avons donc au final, au bout d&rsquo;une demi journée d&rsquo;efforts surhumains (fallait quand même développer le batch initial), atteint nos objectifs.</p>
<p>Reste à regarder cette histoire de flux RSS (sorte d&rsquo;inscription aux nouveautés de la base). Cela est nativement porté par la fonction <a href=http://guide.couchdb.org/editions/1/fr/notifications.html>_changes</a> de CouchDB. C&rsquo;est absolument génial. Comme si vous aviez un trigger permanent et automatique sur chaque modification apportée dans la base. Avec la possibilité de faire un appel à _changes en précisant là où nous en étions la dernière fois que nous y avons fait appel (<a href=http://guide.couchdb.org/editions/1/fr/notifications.html#polling>gestion différentielle</a>), ou encore mieux, <a href=http://guide.couchdb.org/editions/1/fr/notifications.html#continuous>de façon continue</a>, de laisser en permanence un flux HTTP ouvert dans lequel se déverse au fil de l&rsquo;eau chaque changement apporté&mldr;</p>
<p>C&rsquo;est vraiment bluffant et simplissime à l&rsquo;usage.</p>
<p>C&rsquo;en est tellement facile que cela paraît suspect&mldr;</p>
<p>Les prochains tests sont maintenant de faire monter la volumétrie à quelques millions de données pour voir comment cela se passe&mldr;</p>
<p>La suite au prochain numéro !</p>
</div>
<div class=my-4>
<a href=https://david.pilato.fr/tags/couchdb/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#couchdb</a>
<a href=https://david.pilato.fr/tags/elasticsearch/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#elasticsearch</a>
</div>
<div class=py-2>
<div class="flex flex-col md:flex-row items-center my-8">
<a href=https://david.pilato.fr/authors/david-pilato/ class="w-24 h-24 md:mr-4">
<img src=https://david.pilato.fr/authors/david-pilato/david_pilato.png class="w-full bg-primary-bg rounded-full" alt=Avatar>
</a>
<div class="w-full md:w-auto mt-4 md:mt-0">
<a href=https://david.pilato.fr/authors/david-pilato/ class="block font-bold text-lg pb-1 mb-2 border-b">David Pilato</a>
<span class="block pb-2">20+ years of experience, mostly in Java. Living in Cergy, France.</span>
<a href=mailto:david+blog@pilato.fr class=mr-1>
<i class="fas fa-envelope"></i>
</a>
<a href=https://twitter.com/dadoonet class=mr-1>
<i class="fab fa-twitter"></i>
</a>
<a href=https://github.com/dadoonet class=mr-1>
<i class="fab fa-github"></i>
</a>
<a href=https://www.linkedin.com/in/dadoonet/ class=mr-1>
<i class="fab fa-linkedin"></i>
</a>
</div>
</div>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=https://david.pilato.fr/blog/2011-06-20-elasticsearch-et-les-facets/ class=block>Elasticsearch et les "facets"</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=https://david.pilato.fr/blog/2011-03-09-la-recherche-elastique/ class=block>La recherche élastique...</a>
</div>
</div>
</div>
<div class=col-span-2>
<div class="bg-secondary-bg rounded p-6">
<h3 class="text-lg font-semibold mb-4">Series of Posts</h3>
<div class=content>
<a href=https://david.pilato.fr/blog/2011-06-20-elasticsearch-et-les-facets/>Elasticsearch et les "facets"</a>
<br>
<a href=https://david.pilato.fr/blog/2011-05-13-couchdb/>CouchDB</a>
<br>
<a href=https://david.pilato.fr/blog/2011-03-09-la-recherche-elastique/>La recherche élastique...</a>
<br>
</div>
</div>
<div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg">
<span class="text-lg font-semibold">On This Page</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6">
<nav id=TableOfContents>
<ul>
<li><a href=#notre-besoin-résumé>Notre besoin (résumé)</a></li>
<li><a href=#alors-que-peut-faire-couchdb-pour-nous>Alors, que peut faire CouchDB pour nous?</a></li>
</ul>
</nav>
</div>
<script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script>
</div>
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded p-6">
<h2 class="text-lg font-semibold mb-4">See Also</h2>
<div class=content>
<a href=https://david.pilato.fr/blog/2011-03-09-la-recherche-elastique/>La recherche élastique...</a>
<br>
</div>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2022, David Pilato, France
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>